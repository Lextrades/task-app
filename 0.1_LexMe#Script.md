Here's a detailed, step-by-step guide to set up the full-stack SaaS application, structured for easy replication by an autonomous developer LLM or a developer with live coding skills.

---

## Full-Stack SaaS Application Setup Guide (Next.js & Supabase)

This guide will walk you through setting up a full-stack SaaS application featuring task management with AI labeling, image attachments, Google OAuth and email authentication, and Stripe subscriptions.

### Prerequisites

Before you begin, ensure you have the following installed and configured:
*   **Node.js and NPM:** Version 18.x or higher.
*   **Git:** For cloning the project repository.
*   **Text Editor:** Visual Studio Code is recommended.
*   **Basic understanding of:**
    *   Next.js (React)
    *   TypeScript
    *   SQL Databases
    *   Command Line Interface (CLI)

### Chapter 1: Download Project Code

This chapter covers getting the application's source code and setting up the local environment.

**1.1. Clone the GitHub Repository**
Open your terminal and execute the following command to clone the project:
```bash
git clone https://github.com/pixegami/task-app-project
```
Navigate into the newly created project directory:
```bash
cd task-app-project
```

**1.2. Install Node.js Dependencies**
Install all necessary Node.js packages for the project:
```bash
npm install
```
*Note: You might see some warnings about deprecated packages; these can usually be ignored for development purposes.*

**1.3. Create Local Environment Files**
The project uses environment variables, which are stored in `.env.local` and `.env.test.local` files. Example files are provided. Create copies of these example files:
```bash
cp .env.example .env.local
cp .env.example .env.test.local
```
Open `task-app-project` in your text editor (e.g., VS Code). You will see `.env.local` and `.env.test.local` in the root directory. These files will be populated with actual keys later.

---

### Chapter 2: Create Supabase Project

This chapter details setting up your Supabase backend project.

**2.1. Create a Supabase Account and Project**
1.  Go to the Supabase website: `https://supabase.com/`
2.  Log in or create a new account.
3.  From your Supabase dashboard, click **"New Project"**.
4.  **Choose your organization** (create one if you don't have any).
5.  **Project Name:** Enter `task-app` (or your preferred project name).
6.  **Database Password:** Generate a strong password and **copy it** immediately. You will need this later for the Supabase CLI.
7.  **Region:** Select a region closest to you or your target users for optimal performance.
8.  Click **"Create new project"**.
9.  Wait for the project to provision (this may take a few minutes).

**2.2. Retrieve Supabase Project URL and Public API Key**
While your project is provisioning, or once it's ready:
1.  In your Supabase dashboard, go to **Project Settings (cog icon) -> API**.
2.  Under **Project URL**, copy the URL (e.g., `https://oszxkwonekdlbtofbedf.supabase.co`).
3.  Under **Project API Keys**, copy the `anon` (public) key.
    *   *Note: The `service_role` (secret) key should not be shared publicly.*

**2.3. Update Local Environment Files (`.env.local`)**
Open the `.env.local` file in your project and update the following variables with the values you just copied:
```
NEXT_PUBLIC_SUPABASE_URL="https://your-project.supabase.co"
NEXT_PUBLIC_SUPABASE_ANON_KEY="your-anon-key"
```
*   Replace `https://your-project.supabase.co` with your actual project URL.
*   Replace `your-anon-key` with your actual `anon` (public) key.

**2.4. Install and Link Supabase CLI**
1.  **Install Supabase CLI:** Follow the instructions for your operating system on the official Supabase CLI documentation: `https://supabase.com/docs/guides/local-development/cli/getting-started`
    *   For macOS users, you can typically use Homebrew: `brew install supabase/tap/supabase`
2.  **Verify installation:**
    ```bash
supabase --version
```
    *Ensure you are using Supabase CLI version 2.x.x as used in this guide.*
3.  **Login to Supabase CLI:**
    ```bash
supabase login
```
    *This will open a browser window for you to log in to your Supabase account. After successful login, you can close the browser tab.*
4.  **Link your local project to the remote Supabase project:**
    ```bash
supabase link --project-ref your-project-id
```
    *   Replace `your-project-id` with the random ID part of your Supabase URL (e.g., `oszxkwonekdlbtofbedf`).
    *   When prompted to enter your database password, use the password you set during project creation.
    *   You might see a warning about local config differing from the linked project; you can ignore this for now.
5.  **Verify linked projects:**
    ```bash
supabase projects list
```
    *You should see your `task-app` project listed with a dot (`.`) next to it, indicating it's linked.*

---

### Chapter 3: Setup Google Authentication

This chapter guides you through configuring Google OAuth for user authentication.

**3.1. Enable Google Provider in Supabase**
1.  In your Supabase dashboard, go to **Authentication (lock icon) -> Providers**.
2.  Scroll down and expand the **"Google"** section. Keep this page open; you'll return to it soon.

**3.2. Create Google OAuth Credentials**
1.  Go to the Google Cloud Console: `https://console.cloud.google.com/`
2.  Log in or create a new Google Cloud account.
3.  If this is your first time using Google Cloud, you might need to **create a new project**.
    *   Click on the project dropdown in the header and select "New Project."
    *   Give your project a name (e.g., `Pixegami SaaS Sandbox`).
    *   Click "Create."
4.  Once in your Google Cloud project, use the search bar at the top and type "credentials".
5.  Select **"Credentials"** under "APIs & Services".
6.  Click **"+ Create Credentials"** and choose **"OAuth client ID"**.
7.  For **"Application type"**, select **"Web application"**.
8.  **Name:** Enter a name for your OAuth client (e.g., `Task App Project`).
9.  Under **"Authorized JavaScript origins"**, click "+ Add URI" and add the following:
    *   `https://your-project-id.supabase.co` (Replace `your-project-id` with your actual Supabase project ID).
    *   `https://localhost`
    *   `http://localhost`
10. Under **"Authorized redirect URIs"**, click "+ Add URI" and add the following:
    *   `https://your-project-id.supabase.co/auth/v1/callback` (Replace `your-project-id` with your actual Supabase project ID).
11. Click **"Create"**.
12. A pop-up will appear with your **Client ID** and **Client Secret**. **Copy both of these values immediately.**

**3.3. Configure Google in Supabase**
1.  Go back to your Supabase dashboard (Authentication -> Providers -> Google).
2.  Toggle **"Enable Sign in with Google"** to ON.
3.  Paste your **Client ID** into the "Client IDs" field.
4.  Paste your **Client Secret** into the "Client Secret (for OAuth)" field.
5.  Click **"Save"**.
    *You should now see Google listed as "Enabled".*

**3.4. (Optional) Email Provider Configuration**
The video mentions enabling email as a provider and disabling email confirmation for testing purposes. If you wish to do this:
1.  In Supabase, go to **Authentication -> Providers -> Email**.
2.  Toggle **"Enable email provider"** to ON.
3.  Toggle **"Confirm email"** to OFF (for easier testing without email verification).
4.  Click **"Save"**.

---

### Chapter 4: Setup OpenAI API Key

This chapter describes how to get an OpenAI API key for AI features.

**4.1. Create an OpenAI Account and API Key**
1.  Go to the OpenAI Platform: `https://platform.openai.com/`
2.  Log in or create a new account.
3.  Once logged in, use the search bar (or navigate to API keys) and search for "API keys".
4.  Click **"+ Create new secret key"**.
5.  Give your API key an optional name (e.g., `My Test Key`).
6.  Click **"Create secret key"**.
7.  **Copy the secret key immediately.** This key will only be shown once.

**4.2. Set OpenAI API Key as Supabase Backend Secret**
Open your terminal (in the project root) and execute the following command to store your OpenAI API key as a Supabase secret. This makes it accessible to your Edge Functions.
```bash
supabase secrets set OPENAI_API_KEY="your-openai-api-key"
```
*   Replace `your-openai-api-key` with the secret key you just copied from OpenAI.
*   You can verify the secret is set by running `supabase secrets list`.

---

### Chapter 5: Stripe Setup

This chapter covers setting up Stripe for payments and subscriptions.

**5.1. Create a Stripe Account and Enable Test Mode**
1.  Go to Stripe's website: `https://stripe.com/`
2.  Log in or create a new account.
3.  Once in your Stripe dashboard, ensure **"Test mode"** is enabled. You can toggle this using the switch at the top right of the dashboard. This allows you to simulate transactions without real money.

**5.2. Retrieve Stripe Secret Key**
1.  In your Stripe dashboard (still in Test mode), search for "API keys" in the search bar.
2.  Go to **"Developers" -> "API keys"**.
3.  Under **"Standard keys"**, find the "Secret key". Click **"Reveal test key"** and **copy it**. You'll need this for your backend.

**5.3. Create a Subscription Product**
The project uses a "TaskMaster Premium" subscription product. You can create this via the Stripe CLI:
1.  Open your project's `README.md` file (in your text editor).
2.  Scroll down to the "Stripe Setup" section.
3.  You will find a command similar to this (copy the full command from the `README.md`):
    ```bash
stripe prices create \
      --currency=usd \
      --unit-amount=1000 \
      -d "recurring[interval]"="month" \
      -d "recurring[trial_period_days]"=14 \
      -d "product_data[name]"="TaskMaster Premium"
```
4.  Run this command in your terminal (in the project root).
5.  The output will contain an `id` for the created price (e.g., `price_1Q1NIFD1JIyRRRTFK3FxcqBV`). **Copy this Price ID.** You will need it.

**5.4. Configure Customer Portal**
The customer portal allows users to manage their subscriptions.
1.  In your `README.md` file, copy the command for `stripe billing_portal configurations create`. It will look similar to this:
    ```bash
stripe billing_portal configurations create \
      -d "business_profile[privacy_policy_url]"="https://your-site.com/privacy" \
      -d "business_profile[terms_of_service_url]"="https://your-site.com/terms" \
      -d "default_return_url"="http://localhost:3000/profile" \
      -d "features[subscription_cancel][enabled]"=true \
      -d "features[payment_method_update][enabled]"=true
```
2.  **Before running, replace the placeholder URLs** (`https://your-site.com/privacy`, `https://your-site.com/terms`) with relevant URLs for your application or mock URLs if you don't have them yet.
3.  Run this command in your terminal.

**5.5. Add a Webhook Endpoint**
Webhooks allow Stripe to notify your Supabase backend about payment events.
1.  In your Stripe dashboard, search for "Webhooks" in the search bar.
2.  Go to **"Developers" -> "Webhooks"**.
3.  Click **"+ Add endpoint"**.
4.  **Endpoint URL:** This URL will be one of your Supabase Edge Functions. It will look like this (replace `your-project-id`):
    `https://your-project-id.supabase.co/functions/v1/stripe-webhook`
5.  **Select events to listen to:** Click "+ Select events" and add the following four events:
    *   `checkout.session.completed`
    *   `customer.subscription.deleted`
    *   `customer.subscription.updated`
    *   `invoice.payment_failed`
6.  Click **"Add events"**.
7.  Click **"Add endpoint"**.
8.  After the endpoint is created, click **"Reveal"** next to "Signing secret" and **copy the webhook secret**. You will need this.

**5.6. Set Stripe Secrets in Supabase**
You now have all the necessary Stripe keys. Use the Supabase CLI to set them as secrets:
```bash
supabase secrets set STRIPE_SECRET_KEY="your-stripe-secret-key"
supabase secrets set STRIPE_PRICE_ID="your-stripe-price-id"
supabase secrets set STRIPE_WEBHOOK_SECRET="your-stripe-webhook-secret"
```
*   Replace `your-stripe-secret-key` with the secret key from step 5.2.
*   Replace `your-stripe-price-id` with the Price ID from step 5.3.
*   Replace `your-stripe-webhook-secret` with the webhook secret from step 5.5.
*   You can verify them using `supabase secrets list`.

**5.7. (Optional) Add Stripe Secret Key to Supabase Vault**
The project's database trigger for user creation needs access to the Stripe secret key. You can store this securely in Supabase's built-in `vault.secrets` table.
1.  In your Supabase dashboard, go to **SQL Editor**.
2.  Run the following SQL command, replacing `your-stripe-secret-key` with your actual Stripe Secret Key (from step 5.2):
    ```sql
insert into vault.secrets (name, secret)
    values ('stripe', 'your-stripe-secret-key')
    returning key_id;
```
    *If you need to update it later, use:*
    ```sql
update vault.secrets
    set secret = 'your-new-stripe-secret-key'
    where name = 'stripe'
    returning key_id;
```

---

### Chapter 6: Setup Database and Storage

This chapter covers applying the database schema, triggers, and security policies. The storage bucket for images is also configured here.

**6.1. Review Database Schema**
The project's database schema includes three main tables:
*   **`profiles`:** Stores user-specific information (e.g., name, subscription plan, task limits, Stripe customer ID). It's linked to `auth.users` (Supabase's default user table).
*   **`tasks`:** Stores individual tasks, including title, description, image URL, label (personal, work, etc.), due date, and completion status.
*   **`usage_tracking`:** Tracks task creation per user per month for subscription limits.

**6.2. Apply Database Migrations**
The project contains SQL migration files (`supabase/migrations/`) that define the data schema, security policies, and triggers.
1.  Open your terminal (in the project root).
2.  Run the following command to apply all migrations to your remote Supabase database:
    ```bash
supabase db push
```
3.  When prompted, confirm by typing `y`.
    *This command will execute all the SQL files in order, creating tables, functions, triggers, and setting up Row Level Security policies.*

**6.3. Verify Database Setup**
1.  In your Supabase dashboard, go to **Database (database icon) -> Schema Visualizer**.
2.  You should now see a visual representation of your `profiles`, `tasks`, and `usage_tracking` tables, along with their relationships.

**6.4. Verify Storage Bucket Setup**
The migrations also set up a storage bucket for task attachments.
1.  In your Supabase dashboard, go to **Storage (bucket icon)**.
2.  You should see a bucket named `task-attachments`.
3.  Click on `task-attachments`. You'll see that it's configured as "Public" and has restrictions on file size (1MB) and allowed MIME types (images only). This configuration was applied via the migration files.

---

### Chapter 7: Setup Edge Functions

This chapter details deploying the backend logic implemented as Edge Functions.

**7.1. Understand Edge Function Structure**
Edge Functions are serverless functions running on a global network, close to your users. In this project, they are located under `supabase/functions/`. Each subfolder within `functions/` represents a distinct Edge Function.
*   `create-task-with-ai`: Handles task creation and uses OpenAI for automatic labeling.
*   `create-stripe-session`: Generates Stripe checkout sessions or redirects to the customer portal.
*   `stripe-webhook`: Processes webhook events from Stripe (e.g., subscription updates, cancellations).

These functions are implemented in TypeScript and run in a Deno environment. They can access Supabase secrets (like `STRIPE_SECRET_KEY` and `OPENAI_API_KEY`) that you set earlier.

**7.2. Deploy Edge Functions**
From your project root in the terminal, run the following commands to deploy each Edge Function:
```bash
supabase functions deploy create-task-with-ai
supabase functions deploy create-stripe-session
supabase functions deploy stripe-webhook
```
*You will see output indicating the bundling and deployment progress for each function.*

**7.3. Disable JWT Verification for Stripe Webhook Function**
The `stripe-webhook` function is called by Stripe, not by an authenticated user. Therefore, it doesn't need JWT (JSON Web Token) verification.
1.  In your Supabase dashboard, go to **Edge Functions**.
2.  Click on the `stripe-webhook` function.
3.  Go to the **"Details"** tab.
4.  Scroll down to "Function Configuration".
5.  Toggle **"Enforce JWT Verification"** to **OFF**.
6.  Click **"Save"**.
    *This is a crucial step for the webhook to function correctly.*

---

### Chapter 8: Run the Project

Now that all setup is complete, you can run the application locally.

**8.1. Start the Local Development Server**
Open your terminal (in the project root) and run:
```bash
npm run dev
```
This will start the Next.js development server, and you'll see a local URL (e.g., `http://localhost:3000`).

**8.2. Access and Test the Application**
1.  Open the local URL in your browser.
2.  **Login with Google:** Click "Login with Google" and select a Google account. You should be redirected to the dashboard.
3.  **Create a New Task:**
    *   Click "Create Task".
    *   Enter a title and description (e.g., "Walk the dog").
    *   Click "Create Task".
    *   Observe that an appropriate label (e.g., "personal") is automatically assigned by the AI.
4.  **Edit Task and Attach Image:**
    *   Click on the pencil icon next to a task.
    *   Click "Drag and drop an image here" to upload an image.
    *   Click "Save Changes".
    *   The image should be uploaded and displayed.
5.  **Manage Subscription:**
    *   Click on your profile icon in the top right.
    *   Click "Manage Subscription".
    *   You should be redirected to a Stripe checkout page.
6.  **Sign Out:**
    *   Click on your profile icon.
    *   Click "Sign Out". You should be taken back to the login page.

---

### Chapter 9: Project Structure for Extension

This section provides an overview of the project's folder structure, useful if you want to extend or modify the application.

```
task-app-project/
├── app/                  # Next.js pages and layouts (UI and routing)
├── components/           # React components (reusable UI elements)
├── hooks/                # Application logic (custom React hooks for data fetching, auth, etc.)
│   ├── useAuth.ts        # Authentication logic (Supabase auth client)
│   ├── useTask.ts        # Task management logic (CRUD operations on tasks)
│   └── useUser.ts        # User profile and subscription logic
├── supabase/             # Supabase specific configurations and code
│   ├── functions/        # Supabase Edge Functions (backend serverless logic)
│   ├── migrations/       # Database migrations (SQL files for schema changes, triggers, policies)
│   └── tests/            # Integration tests (for backend functionality)
│       └── integration/  # Jest integration tests
├── .env.example          # Example environment variables
├── .env.local            # Local environment variables for development
├── .env.test.local       # Local environment variables for testing
├── next.config.mjs       # Next.js configuration
├── package.json          # Project dependencies and scripts
├── tsconfig.json         # TypeScript configuration
└── README.md             # Project README
```

---

### Chapter 10: Running Tests

The project includes an integration test suite for the backend functionality.

**10.1. Configure Test Environment Variables**
Open `.env.test.local` and populate it with the same values as `.env.local`, including all API keys and secrets. The integration tests will connect to your actual Supabase project.

**10.2. Run All Tests**
From your project root in the terminal, execute:
```bash
npm test
```
*   This will run all Jest tests located in the `tests/integration/` directory.
*   Tests might fail the first time due to cold starts or database state. Try running them again if they fail initially.

**10.3. Run Specific Test Files**
If you want to run only a specific test file, use the following command (replace with the actual path to your test file):
```bash
npm test tests/integration/2_auth.test.ts
```
---

You have now successfully set up and run the full-stack SaaS application. This guide provides all the necessary information to rebuild the project from scratch and serves as a strong foundation for further development and customization.Enter `task-app` (or your preferred project name).
6.  **Database Password:** Generate a strong password and **copy it** immediately. You will need this later for the Supabase CLI.
7.  **Region:** Select a region closest to you or your target users for optimal performance.
8.  Click **"Create new project"**.
9.  Wait for the project to provision (this may take a few minutes).

**2.2. Retrieve Supabase Project URL and Public API Key**
While your project is provisioning, or once it's ready:
1.  In your Supabase dashboard, go to **Project Settings (cog icon) -> API**.
2.  Under **Project URL**, copy the URL (e.g., `https://oszxkwonekdlbtofbedf.supabase.co`).
3.  Under **Project API Keys**, copy the `anon` (public) key.
    *   *Note: The `service_role` (secret) key should not be shared publicly.*

**2.3. Update Local Environment Files (`.env.local`)**
Open the `.env.local` file in your project and update the following variables with the values you just copied:
```
NEXT_PUBLIC_SUPABASE_URL="https://your-project.supabase.co"
NEXT_PUBLIC_SUPABASE_ANON_KEY="your-anon-key"```
*   Replace `https://your-project.supabase.co` with your actual project URL.
*   Replace `your-anon-key` with your actual `anon` (public) key.

**2.4. Install and Link Supabase CLI**
1.  **Install Supabase CLI:** Follow the instructions for your operating system on the official Supabase CLI documentation: `https://supabase.com/docs/guides/local-development/cli/getting-started`
    *   For macOS users, you can typically use Homebrew: `brew install supabase/tap/supabase`
2.  **Verify installation:**
    ```bash
    supabase --version
    ```
    *Ensure you are using Supabase CLI version 2.x.x as used in this guide.*
3.  **Login to Supabase CLI:**
    ```bash
    supabase login
    ```
    *This will open a browser window for you to log in to your Supabase account. After successful login, you can close the browser tab.*
4.  **Link your local project to the remote Supabase project:**
    ```bash
    supabase link --project-ref your-project-id
    ```
    *   Replace `your-project-id` with the random ID part of your Supabase URL (e.g., `oszxkwonekdlbtofbedf`).
    *   When prompted to enter your database password, use the password you set during project creation.
    *   You might see a warning about local config differing from the linked project; you can ignore this for now.
5.  **Verify linked projects:**
    ```bash
    supabase projects list
    ```
    *You should see your `task-app` project listed with a dot (`.`) next to it, indicating it's linked.*

---

### Chapter 3: Setup Google Authentication

This chapter guides you through configuring Google OAuth for user authentication.

**3.1. Enable Google Provider in Supabase**
1.  In your Supabase dashboard, go to **Authentication (lock icon) -> Providers**.
2.  Scroll down and expand the **"Google"** section. Keep this page open; you'll return to it soon.

**3.2. Create Google OAuth Credentials**
1.  Go to the Google Cloud Console: `https://console.cloud.google.com/`
2.  Log in or create a new Google Cloud account.
3.  If this is your first time using Google Cloud, you might need to **create a new project**.
    *   Click on the project dropdown in the header and select "New Project."
    *   Give your project a name (e.g., `Pixegami SaaS Sandbox`).
    *   Click "Create."
4.  Once in your Google Cloud project, use the search bar at the top and type "credentials".
5.  Select **"Credentials"** under "APIs & Services".
6.  Click **"+ Create Credentials"** and choose **"OAuth client ID"**.
7.  For **"Application type"**, select **"Web application"**.
8.  **Name:** Enter a name for your OAuth client (e.g., `Task App Project`).
9.  Under **"Authorized JavaScript origins"**, click "+ Add URI" and add the following:
    *   `https://your-project-id.supabase.co` (Replace `your-project-id` with your actual Supabase project ID).
    *   `https://localhost`
    *   `http://localhost`
10. Under **"Authorized redirect URIs"**, click "+ Add URI" and add the following:
    *   `https://your-project-id.supabase.co/auth/v1/callback` (Replace `your-project-id` with your actual Supabase project ID).
11. Click **"Create"**.
12. A pop-up will appear with your **Client ID** and **Client Secret**. **Copy both of these values immediately.**

**3.3. Configure Google in Supabase**
1.  Go back to your Supabase dashboard (Authentication -> Providers -> Google).
2.  Toggle **"Enable Sign in with Google"** to ON.
3.  Paste your **Client ID** into the "Client IDs" field.
4.  Paste your **Client Secret** into the "Client Secret (for OAuth)" field.
5.  Click **"Save"**.
    *You should now see Google listed as "Enabled".*

**3.4. (Optional) Email Provider Configuration**
The video mentions enabling email as a provider and disabling email confirmation for testing purposes. If you wish to do this:
1.  In Supabase, go to **Authentication -> Providers -> Email**.
2.  Toggle **"Enable email provider"** to ON.
3.  Toggle **"Confirm email"** to OFF (for easier testing without email verification).
4.  Click **"Save"**.

---

### Chapter 4: Setup OpenAI API Key

This chapter describes how to get an OpenAI API key for AI features.

**4.1. Create an OpenAI Account and API Key**
1.  Go to the OpenAI Platform: `https://platform.openai.com/`
2.  Log in or create a new account.
3.  Once logged in, use the search bar (or navigate to API keys) and search for "API keys".
4.  Click **"+ Create new secret key"**.
5.  Give your API key an optional name (e.g., `My Test Key`).
6.  Click **"Create secret key"**.
7.  **Copy the secret key immediately.** This key will only be shown once.

**4.2. Set OpenAI API Key as Supabase Backend Secret**
Open your terminal (in the project root) and execute the following command to store your OpenAI API key as a Supabase secret. This makes it accessible to your Edge Functions.
```bash
supabase secrets set OPENAI_API_KEY="your-openai-api-key"
```
*   Replace `your-openai-api-key` with the secret key you just copied from OpenAI.
*   You can verify the secret is set by running `supabase secrets list`.

---

### Chapter 5: Stripe Setup

This chapter covers setting up Stripe for payments and subscriptions.

**5.1. Create a Stripe Account and Enable Test Mode**
1.  Go to Stripe's website: `https://stripe.com/`
2.  Log in or create a new account.
3.  Once in your Stripe dashboard, ensure **"Test mode"** is enabled. You can toggle this using the switch at the top right of the dashboard. This allows you to simulate transactions without real money.

**5.2. Retrieve Stripe Secret Key**
1.  In your Stripe dashboard (still in Test mode), search for "API keys" in the search bar.
2.  Go to **"Developers" -> "API keys"**.
3.  Under **"Standard keys"**, find the "Secret key". Click **"Reveal test key"** and **copy it**. You'll need this for your backend.

**5.3. Create a Subscription Product**
The project uses a "TaskMaster Premium" subscription product. You can create this via the Stripe CLI:
1.  Open your project's `README.md` file (in your text editor).
2.  Scroll down to the "Stripe Setup" section.
3.  You will find a command similar to this (copy the full command from the `README.md`):
    ```bash
    stripe prices create \
      --currency=usd \
      --unit-amount=1000 \
      -d "recurring[interval]"="month" \
      -d "recurring[trial_period_days]"=14 \
      -d "product_data[name]"="TaskMaster Premium"
    ```
4.  Run this command in your terminal (in the project root).
5.  The output will contain an `id` for the created price (e.g., `price_1Q1NIFD1JIyRRRTFK3FxcqBV`). **Copy this Price ID.** You will need it.

**5.4. Configure Customer Portal**
The customer portal allows users to manage their subscriptions.
1.  In your `README.md` file, copy the command for `stripe billing_portal configurations create`. It will look similar to this:
    ```bash
    stripe billing_portal configurations create \
      -d "business_profile[privacy_policy_url]"="https://your-site.com/privacy" \
      -d "business_profile[terms_of_service_url]"="https://your-site.com/terms" \
      -d "default_return_url"="http://localhost:3000/profile" \
      -d "features[subscription_cancel][enabled]"=true \
      -d "features[payment_method_update][enabled]"=true
    ```
2.  **Before running, replace the placeholder URLs** (`https://your-site.com/privacy`, `https://your-site.com/terms`) with relevant URLs for your application or mock URLs if you don't have them yet.
3.  Run this command in your terminal.

**5.5. Add a Webhook Endpoint**
Webhooks allow Stripe to notify your Supabase backend about payment events.
1.  In your Stripe dashboard, search for "Webhooks" in the search bar.
2.  Go to **"Developers" -> "Webhooks"**.
3.  Click **"+ Add endpoint"**.
4.  **Endpoint URL:** This URL will be one of your Supabase Edge Functions. It will look like this (replace `your-project-id`):
    `https://your-project-id.supabase.co/functions/v1/stripe-webhook`
5.  **Select events to listen to:** Click "+ Select events" and add the following four events:
    *   `checkout.session.completed`
    *   `customer.subscription.deleted`
    *   `customer.subscription.updated`
    *   `invoice.payment_failed`
6.  Click **"Add events"**.
7.  Click **"Add endpoint"**.
8.  After the endpoint is created, click **"Reveal"** next to "Signing secret" and **copy the webhook secret**. You will need this.

**5.6. Set Stripe Secrets in Supabase**
You now have all the necessary Stripe keys. Use the Supabase CLI to set them as secrets:
```bash
supabase secrets set STRIPE_SECRET_KEY="your-stripe-secret-key"
supabase secrets set STRIPE_PRICE_ID="your-stripe-price-id"
supabase secrets set STRIPE_WEBHOOK_SECRET="your-stripe-webhook-secret"
```
*   Replace `your-stripe-secret-key` with the secret key from step 5.2.
*   Replace `your-stripe-price-id` with the Price ID from step 5.3.
*   Replace `your-stripe-webhook-secret` with the webhook secret from step 5.5.
*   You can verify them using `supabase secrets list`.

**5.7. (Optional) Add Stripe Secret Key to Supabase Vault**
The project's database trigger for user creation needs access to the Stripe secret key. You can store this securely in Supabase's built-in `vault.secrets` table.
1.  In your Supabase dashboard, go to **SQL Editor**.
2.  Run the following SQL command, replacing `your-stripe-secret-key` with your actual Stripe Secret Key (from step 5.2):
    ```sql
    insert into vault.secrets (name, secret)
    values ('stripe', 'your-stripe-secret-key')
    returning key_id;
    ```
    *If you need to update it later, use:*
    ```sql
    update vault.secrets
    set secret = 'your-new-stripe-secret-key'
    where name = 'stripe'
    returning key_id;
    ```

---

### Chapter 6: Setup Database and Storage

This chapter covers applying the database schema, triggers, and security policies. The storage bucket for images is also configured here.

**6.1. Review Database Schema**
The project's database schema includes three main tables:
*   **`profiles`:** Stores user-specific information (e.g., name, subscription plan, task limits, Stripe customer ID). It's linked to `auth.users` (Supabase's default user table).
*   **`tasks`:** Stores individual tasks, including title, description, image URL, label (personal, work, etc.), due date, and completion status.
*   **`usage_tracking`:** Tracks task creation per user per month for subscription limits.

**6.2. Apply Database Migrations**
The project contains SQL migration files (`supabase/migrations/`) that define the data schema, security policies, and triggers.
1.  Open your terminal (in the project root).
2.  Run the following command to apply all migrations to your remote Supabase database:
    ```bash
    supabase db push
    ```
3.  When prompted, confirm by typing `y`.
    *This command will execute all the SQL files in order, creating tables, functions, triggers, and setting up Row Level Security policies.*

**6.3. Verify Database Setup**
1.  In your Supabase dashboard, go to **Database (database icon) -> Schema Visualizer**.
2.  You should now see a visual representation of your `profiles`, `tasks`, and `usage_tracking` tables, along with their relationships.

**6.4. Verify Storage Bucket Setup**
The migrations also set up a storage bucket for task attachments.
1.  In your Supabase dashboard, go to **Storage (bucket icon)**.
2.  You should see a bucket named `task-attachments`.
3.  Click on `task-attachments`. You'll see that it's configured as "Public" and has restrictions on file size (1MB) and allowed MIME types (images only). This configuration was applied via the migration files.

---

### Chapter 7: Setup Edge Functions

This chapter details deploying the backend logic implemented as Edge Functions.

**7.1. Understand Edge Function Structure**
Edge Functions are serverless functions running on a global network, close to your users. In this project, they are located under `supabase/functions/`. Each subfolder within `functions/` represents a distinct Edge Function.
*   `create-task-with-ai`: Handles task creation and uses OpenAI for automatic labeling.
*   `create-stripe-session`: Generates Stripe checkout sessions or redirects to the customer portal.
*   `stripe-webhook`: Processes webhook events from Stripe (e.g., subscription updates, cancellations).

These functions are implemented in TypeScript and run in a Deno environment. They can access Supabase secrets (like `STRIPE_SECRET_KEY` and `OPENAI_API_KEY`) that you set earlier.

**7.2. Deploy Edge Functions**
From your project root in the terminal, run the following commands to deploy each Edge Function:
```bash
supabase functions deploy create-task-with-ai
supabase functions deploy create-stripe-session
supabase functions deploy stripe-webhook
```
*You will see output indicating the bundling and deployment progress for each function.*

**7.3. Disable JWT Verification for Stripe Webhook Function**
The `stripe-webhook` function is called by Stripe, not by an authenticated user. Therefore, it doesn't need JWT (JSON Web Token) verification.
1.  In your Supabase dashboard, go to **Edge Functions**.
2.  Click on the `stripe-webhook` function.
3.  Go to the **"Details"** tab.
4.  Scroll down to "Function Configuration".
5.  Toggle **"Enforce JWT Verification"** to **OFF**.
6.  Click **"Save"**.
    *This is a crucial step for the webhook to function correctly.*

---

### Chapter 8: Run the Project

Now that all setup is complete, you can run the application locally.

**8.1. Start the Local Development Server**
Open your terminal (in the project root) and run:
```bash
npm run dev
```
This will start the Next.js development server, and you'll see a local URL (e.g., `http://localhost:3000`).

**8.2. Access and Test the Application**
1.  Open the local URL in your browser.
2.  **Login with Google:** Click "Login with Google" and select a Google account. You should be redirected to the dashboard.
3.  **Create a New Task:**
    *   Click "Create Task".
    *   Enter a title and description (e.g., "Walk the dog").
    *   Click "Create Task".
    *   Observe that an appropriate label (e.g., "personal") is automatically assigned by the AI.
4.  **Edit Task and Attach Image:**
    *   Click on the pencil icon next to a task.
    *   Click "Drag and drop an image here" to upload an image.
    *   Click "Save Changes".
    *   The image should be uploaded and displayed.
5.  **Manage Subscription:**
    *   Click on your profile icon in the top right.
    *   Click "Manage Subscription".
    *   You should be redirected to a Stripe checkout page.
6.  **Sign Out:**
    *   Click on your profile icon.
    *   Click "Sign Out". You should be taken back to the login page.

---

### Chapter 9: Project Structure for Extension

This section provides an overview of the project's folder structure, useful if you want to extend or modify the application.

```
task-app-project/
├── app/                  # Next.js pages and layouts (UI and routing)
├── components/           # React components (reusable UI elements)
├── hooks/                # Application logic (custom React hooks for data fetching, auth, etc.)
│   ├── useAuth.ts        # Authentication logic (Supabase auth client)
│   ├── useTask.ts        # Task management logic (CRUD operations on tasks)
│   └── useUser.ts        # User profile and subscription logic
├── supabase/             # Supabase specific configurations and code
│   ├── functions/        # Supabase Edge Functions (backend serverless logic)
│   ├── migrations/       # Database migrations (SQL files for schema changes, triggers, policies)
│   └── tests/            # Integration tests (for backend functionality)
│       └── integration/  # Jest integration tests
├── .env.example          # Example environment variables
├── .env.local            # Local environment variables for development
├── .env.test.local       # Local environment variables for testing
├── next.config.mjs       # Next.js configuration
├── package.json          # Project dependencies and scripts
├── tsconfig.json         # TypeScript configuration
└── README.md             # Project README
```

---

### Chapter 10: Running Tests

The project includes an integration test suite for the backend functionality.

**10.1. Configure Test Environment Variables**
Open `.env.test.local` and populate it with the same values as `.env.local`, including all API keys and secrets. The integration tests will connect to your actual Supabase project.

**10.2. Run All Tests**
From your project root in the terminal, execute:
```bash
npm test
```
*   This will run all Jest tests located in the `tests/integration/` directory.
*   Tests might fail the first time due to cold starts or database state. Try running them again if they fail initially.

**10.3. Run Specific Test Files**
If you want to run only a specific test file, use the following command (replace with the actual path to your test file):
```bash
npm test tests/integration/2_auth.test.ts
```
---

You have now successfully set up and run the full-stack SaaS application. This guide provides all the necessary information to rebuild the project from scratch and serves as a strong foundation for further development and customization.