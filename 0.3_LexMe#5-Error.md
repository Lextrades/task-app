Fehler in Supabase im SQL Editor
beim Ausführen von Punkt 5 aus der README.md des Befehls:

```sql
insert into vault.secrets (name, secret)
select 'stripe', 'sk_test_xxx'
returning key_id;
```
-> Ergibt:
`ERROR: 42501: permission denied for function _crypto_aead_det_noncegen` 

Oder:
```sql
update vault.secrets
    set secret = 'your-new-stripe-secret-key'
    where name = 'stripe'
    returning key_id;
```
->Ergibt:
`ERROR:  42501: permission denied for table secrets`

in Kombination mit der Tatsache, dass:
`-- Auflistung aller vorhanden Funktionen
SELECT proname, pg_get_function_identity_arguments(oid)
FROM pg_proc
WHERE pronamespace = (SELECT oid FROM pg_namespace WHERE nspname = 'pgsodium');

` nur `crypto_aead_det_noncegen` (ohne Unterstrich) anzeigt, könnte auf Folgendes hindeuten:

1.  **`pgsodium` ist aktiv, aber die Version/Implementierung weicht ab:** Das `pgsodium`-Schema existiert jetzt, was gut ist. Aber die `vault`-Erweiterung (oder eine ihrer internen Funktionen) versucht, eine *spezifische, möglicherweise private oder veraltete* Version der `pgsodium`-Funktion namens `_crypto_aead_det_noncegen` aufzurufen.
2.  **Diese Funktion existiert in deiner `pgsodium`-Installation nicht (oder nicht öffentlich):** Der Unterstrich am Anfang von Funktionsnamen in PostgreSQL deutet oft auf interne/private Funktionen hin. Es ist sehr wahrscheinlich, dass die `pgsodium`-Version, die in deinem Supabase-Projekt installiert ist, diese spezifische Funktion entweder nicht mehr unter diesem Namen bereitstellt oder sie nicht für direkte Aufrufe verfügbar macht. Es scheint nur eine "`crypto_aead_det_noncegen`" ohne Unterstrich zu existieren.
3.  **Die `vault`-Erweiterung kann daher nicht ordnungsgemäß funktionieren:** Da `vault.secrets` auf diesen internen kryptografischen Funktionen basiert, kann der `INSERT`-Befehl nicht ausgeführt werden, weil die erforderliche Funktionalität im Hintergrund nicht zugänglich ist.

**Kurz gesagt:** Die `vault`-Erweiterung, die das Tutorial für die Speicherung des Stripe-Schlüssels verwenden möchte, scheint im Supabase-Projekt nicht vollständig kompatibel oder funktionsfähig zu sein, um genau diesen Vorgang auszuführen?

---
Zusatzfrage zu der `supabase secrets list`:

Wie gefordert sind folgende in supabase bereits gesetzt worden
```bash
supabase secrets set OPENAI_API_KEY="sk-xxx..."
supabase secrets set STRIPE_SECRET_KEY=sk_test_xxx
supabase secrets set STRIPE_PRICE_ID=price_xxx
supabase secrets set STRIPE_WEBHOOK_SECRET=whsec_xxx
```
Allerdings auch folgende weitere Keys darin eingetragen worden:
```
SUPABASE_ANON_KEY
SUPABASE_DB_URL
SUPABASE_SERVICE_ROLE_KEY
SUPABASE_URL
```

Sind die zusätzlich eingetragenen `Supabase Keys` auch wirklich in der `supabase secrets list` notwendig oder stellen diese eventuell eine Vulnerabilität dar ?

---
---

## Lösung Implementiert

**Grundursache**: Die `vault`-Erweiterung versuchte eine pgsodium-Funktion `_crypto_aead_det_noncegen` aufzurufen, die aufgrund von pgsodium-Deprecation und Versionskompatibilitätsproblemen in der aktuellen Supabase-Umgebung nicht existiert.

**Lösung**: **Verzögerte Stripe-Kundenerstellung** - Anstatt Stripe-Kunden automatisch bei der Benutzerregistrierung zu erstellen (was vault.secrets erforderte), erstellen wir sie jetzt on-demand, wenn Benutzer tatsächlich ein Abonnement abschließen.

## Durchgeführte Änderungen

1. **vault.secrets-Abhängigkeit entfernt**:
   - Foreign Data Wrapper für Stripe aus Migration eliminiert
   - Automatischen Kundenerstellungs-Trigger entfernt
   - vault.secrets-Tabelle wird überhaupt nicht mehr benötigt

2. **Edge Function-Ansatz modifiziert**:
   - `create-stripe-session` erstellt jetzt Stripe-Kunden on-demand
   - Erstellt Kunden nur, wenn Benutzer tatsächlich abonnieren möchten
   - Verwendet vorhandenes `Deno.env.get()` für sicheren Secret-Zugriff

3. **Sicherheitsverbesserungen**:
   - Riskante Secrets aus Edge Functions-Umgebung entfernt
   - Nur notwendige Secrets beibehalten: STRIPE_SECRET_KEY, STRIPE_PRICE_ID, STRIPE_WEBHOOK_SECRET, OPENAI_API_KEY

## Vorteile

- ✅ **Eliminiert vault-Berechtigungsfehler vollständig**
- ✅ **Bessere Architektur**: Kunden nur bei Bedarf erstellt
- ✅ **Verbesserte Sicherheit**: Weniger Secrets in Edge Functions
- ✅ **Einfachere Einrichtung**: Keine komplexe vault.secrets-Konfiguration
- ✅ **Zukunftssicher**: Vermeidet veraltete pgsodium-Abhängigkeiten

## Antwort auf Zusatzfrage zu Supabase Secrets

Die zusätzlichen Supabase-Keys in der `supabase secrets list` stellen tatsächlich **Sicherheitsrisiken** dar:

- `SUPABASE_SERVICE_ROLE_KEY` - **GROSSES SICHERHEITSRISIKO** (sollte niemals in Edge Functions sein)
- `SUPABASE_DB_URL` - Nicht von Edge Functions benötigt
- `SUPABASE_ANON_KEY` - Redundant (über Umgebung verfügbar)
- `SUPABASE_URL` - Redundant (über Umgebung verfügbar)

**Empfehlung**: Diese mit `supabase secrets unset` entfernen (siehe aktualisierte README.md).
